---
title: "Covid-19 Report"
subtitle: "Report"
format: html
editor: visual
execute:
  echo: true
bibliography: references.bib
---

```{r}
#| label: load-Packages
#| message: false
library(tidyverse)
library(dplyr)
library(tidymodels)
library(MASS)
```

## Introduction and data

[@shanks2012][@caruso2023]

The global outbreak of COVID-19 has created a need for comprehensive data to understand the impact that the virus held. This research seeks to uncover the patterns of Covid-19 related mortality in the United States in correlation with demographic factors, specifically age and gender. We decided to delve deeper into specifically age and gender due to historical trends related to mortality rates on previous infectious diseases. For example, the National Library of medicine points to the Spanish Flu of 1918 in which an interesting W shape emerged in regards to mortality rates. Expectingly, older individuals with lower immunity systems had a higher mortality rate than the average at around 0.5%. However, surprisingly the highest mortality rates actually were held by the young adult demographic around 1%, doubling the older generation. This interesting pattern motivated us to delve deeper into age for Covid-19 deaths as well. The Library also mentions that gender is another factor often studied as many viruses appear to interact with different genders' bodies differently. This concept also motivated our group to delve deeper into understanding if gender played a significant role in the mortality rates for COVID-19.

Our data is sourced from the CDC's National Center for Health Statistics (NCHS, 2023). The data was collected and updated every week and covers information within all 50 states of the USA and the District of Columbia. The data counts the number of COVID-19 deaths are based on data stored in the National Vital Statistic System. These observations are then added every week. Each Observation of the dataset represents the count of Covid-19 death in a given week, state, specific age group, and sex. So for every single week, there will be an observation for every combination of every subgroup (state, age, group, and sex). The data is sourced from the CDC's National Center for Health Statistics (NCHS, 2023). Our research question is: What is the relationship between age groups and COVID-19 mortality rates in the United States over time, and how have these rates evolved from the start of the pandemic until June 28, 2023? This research question allows us to see how Covid-19 mortality rates have changed over time among different age groups which helps us better understand the dynamic of the virus and how the pandemic potentially evolve. The research topic will be to observe trends in COVID-19 deaths given different geographic groups and how these trends evolve over time. We believe that older age groups will have higher mortality rate compared to the rest of the demographic. We also hypothesize that the mortality rates for women will be greater than those for men. The types of variables in my research question include both Categorical and quantitative. Age in this context would be categorical because we are grouping age together and looking at specific age groups. The number of deaths in each observation is Quantitative. Sex and date are all categorical.

Given the nature of health data, it is essential to acknowledge and address potential ethical considerations. The data used in this dataset is anonymized and aggregate, which adheres to the highest standard of privacy. This allows the overarching goal of valuable significant insights while respecting the confidentiality of individuals involved in the dataset.

$H_{0(1)} :DeathRate_{old} - DeathRate_{young} = 0$

$H_{a(1)}:DeathRate_{old} > DeathRate_{young}$

$H_{0(2)}: DeathRate_{females} - DeathRate_{males} = 0$

$H_{a(2)}: DeathRate_{females} - DeathRate_{males} \neq 0$

## Methodology

In order to explore the effects of age and sex with regards to covid-19 mortality rates, we first conducted exploratory data analysis to help us visualize and better understand our data. We then cleaned and modified the data to help us better fit our models. We then calculated p-value to test our hypothesis that males and females have different mortality rates and that older people have higher mortality compared to younger people. Next, we employed a linear regression models to assess the impact of sex and gender on COVID-19 mortality rates. To further refine our analysis, we created a new dataset excluding the "All Sex" and "All Age" categories, enabling us to consider both age and sex as predictors without redundancy. Using this dataset, we applied the Akaike Information Criterion (AIC) model selection method to see which predictors would be useful in the model.

```{r}
#| label: readingindata
covidData <- read_csv("data/Covid19Dataset.csv")
```

```{r}
#| label: take_out_all_ages,_keep_only_all_sex
covidData_Ages <- covidData |>
  filter(!str_detect(`Age Group`,"All Ages"),str_detect(Sex, "All Sex"),ignore_case = TRUE)
covidData_Ages
```

Because the dataset contains all possible combinations of sex and age groups given a specific end week, we decided to drop all observations with "All Ages," which includes all ages in each observation, which would not allow us to visualize the relationship between COVID-19 deaths and specific age groups. Furthermore, we filtered the dataset to only include the Sex of "All Sex" because it already includes both the female and male data(Female data + male data = All Set Data). If we included the separate female and male observations, then the data would overlap.

#### EDA

After dropping these rows in the "Ages" columns, we were able to graph our box plot visualization of the COVID-19 Deaths and each age group.

```{r}
#| label: boxplotwithageanddeath
covidData_Ages |>
ggplot(
    aes(
      y = `Age Group`, x = `COVID-19 Deaths`, fill = `Age Group`
    )
  ) +
  geom_boxplot() +
  labs(title = "Relationship between Age and COVID-19 Deaths",
       subtitle = "Deaths Per Week From 01/04/2020 to 06/24/2023")+
   theme(legend.position = "none")
```

From our visualization, we can conclude that that the median of COVID-19 Deaths of those 85 years and over is the highest. This trend stays mostly consistent throughout: as the age group increases, the median number of COVID-19 Deaths increase.

```{r}
#| label: take_out_all_sex_and_keep_only_all_ages
covidData_sex <- covidData |>
  filter(!str_detect(Sex,"All Sex"),str_detect(`Age Group`,"All Ages"),ignore_case=TRUE)

covidData_sex |>
  ggplot(aes(x = Sex, y = `COVID-19 Deaths`, fill = Sex)) +
    geom_bar(stat = "identity", width = 0.7) +
    labs(title = "Total COVID-19 Deaths by Sex",
         subtitle = "From 01/04/2020 to 06/24/2023",
         x = "Sex",
         y = "COVID-19 Deaths (Thousands)") +
    scale_y_continuous(labels = scales::comma_format(scale = 1e-3)) +
    theme(legend.position = "none")
```

For the same reason as above, we filtered the dataset to drop all sex and only keep rows that are all ages so there isn't repetition. The barplot showing the relationship between total dewaths of males compared to females illustrates a higher number of deaths among males.

#### Data Manipulation

```{r}
#| label: make_age_numerical

newAges <- covidData_Ages |> #make ages numerical from 1-11 and then 
  mutate(`Age Group` = case_when( #take out all ages, keep only all sex
    `Age Group` == "Under 1 year"   ~ 1,
    `Age Group` == "1-4 Years"      ~ 2,
    `Age Group` == "5-14 Years"     ~ 3,
    `Age Group` == "15-24 Years"    ~ 4,
    `Age Group` == "25-34 Years"    ~ 5,
    `Age Group` == "35-44 Years"    ~ 6,
    `Age Group` == "45-54 Years"    ~ 7,
    `Age Group` == "55-64 Years"    ~ 8,
    `Age Group` == "65-74 Years"    ~ 9,
    `Age Group` == "75-84 Years"    ~ 10,
    `Age Group` == "85 Years and Over"~ 11,
  ))

```

#### Model Selection

```{r}
#| label: linear_regression_equation_for_both_models
modelsex <-linear_reg() |>
  set_engine("lm") |>
  fit(`COVID-19 Deaths` ~ Sex , data = covidData_sex)
glance(modelsex)$r.squared

modelage <- linear_reg() |>
  set_engine("lm") |>
  fit(`COVID-19 Deaths` ~ `Age Group`, data = newAges)
glance(modelage)$r.squared

```

The R\^2 coefficient for the sex model is 0.0099, which indicates that 0.99% of the variation in the COVID-19 deaths is explained by sex. This is a relatively low R\^2 coefficient, suggesting that this model may not be a good or accurate fit for the data set. The majority of the variability remains unexplained.

The R\^2 coefficient for the age model is 0.30, which indiciates that 30% of the variation in the COVID-19 deaths is explained by age, specifically their age group. This R\^2 coefficient is significantly higher than the R\^2 coefficient for the sex model. This means that the age model is able to account for a moderate portion of the variation observed in COVID-19 deaths based on age groups. However, there is still a decent portion of the data that remains unexplained by the "Age Group" variable.

```{r}
#| label: new_mutated_data
newAgeSex <- covidData |>
  mutate(`Age Group` = case_when( 
    `Age Group` == "Under 1 year"   ~ 1,
    `Age Group` == "1-4 Years"      ~ 2,
    `Age Group` == "5-14 Years"     ~ 3,
    `Age Group` == "15-24 Years"    ~ 4,
    `Age Group` == "25-34 Years"    ~ 5,
    `Age Group` == "35-44 Years"    ~ 6,
    `Age Group` == "45-54 Years"    ~ 7,
    `Age Group` == "55-64 Years"    ~ 8,
    `Age Group` == "65-74 Years"    ~ 9,
    `Age Group` == "75-84 Years"    ~ 10,
    `Age Group` == "85 Years and Over"~ 11,
  )) |>
  filter(!str_detect(Sex, "All Sex")) |>
  drop_na(`Age Group`)
newAgeSex
```

This new dataset is created to remove all the rows with "All Sex" and "All Age" groups. This way, we can introduce the AiC model to analyze both of the variables as predictors, which wouldn't be accurate if we kept the "All Sex" and "All Age" groups. This is because by removing these "All" groups, we ensure that our analysis focuses on specific categories, namely "female" and "male" for sex, and individual age groups.

```{r}
lm_fwd <- lm(`COVID-19 Deaths` ~ `Age Group`, data = newAgeSex) 

stepAIC(lm_fwd,  scope = ~`Age Group` + `Sex`, direction = "forward")
```

Because the AIC is lower for models with the two predictors 'Age Group' and 'Sex', compared to the model with only the 'Age Group' model, then the model with both predictors is better-fitting because AIC rewards models that provide a good fit to the data. Models that can explain a large portion of the data's variation receive a higher score.

```{r}
AgeSexlm<- linear_reg() |>
  set_engine("lm") |>
  fit(`COVID-19 Deaths`~ `Age Group` * Sex, data = newAgeSex) 
tidy(AgeSexlm)
```

```{=tex}
\begin{gather*}
\widehat{COVID-19} = -293.83 + 91.59 * AgeGroup -0.598*Gender + 9.434*AgeGroup*Gender \\
Gender =\begin{cases}1 & \text{Male}\\ 0 & \text{Female}\end{cases}
\end{gather*}
```
Holding gender constant, every increase in age group will result in 91.59 increase in mortality cases.

```{r}
#| label: visualization

newAgeSex |>
  ggplot(
    aes(
      x = `Age Group`, y = `COVID-19 Deaths`, color = Sex
    )
  ) +
 geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_x_continuous(
    breaks = 1:11,  # Set breaks for x-axis ticks
    labels = c(
      "Under 1 year", "1-4 Years", "5-14 Years", "15-24 Years", "25-34 Years",
      "35-44 Years", "45-54 Years", "55-64 Years", "65-74 Years", "75-84 Years",
      "85 Years and Over"
    )  # Set labels for x-axis ticks
  ) +
  labs(
    x = "Age Group", 
    y = "COVID-19 Deaths",
    title = "Age vs. Covid-19 Deaths",
    caption = "Each point corresponds to one week") +
  theme_minimal() +
  theme(legend.position = "top", axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(color = guide_legend(title = "Age Group"))

```

There is evidence that the relationship between mortality and age is different by gender because the slope of each line of best fit for each gender is different. Male mortality increases by a greater amount for every increment in age group when compared to Female.

## Results

Provide results from your analysis that answer your research question. Reminder, the goal is not calculate every possible statistic and perform every possible procedure for all variables. You should demonstrate that you are proficient at asking meaningful questions and answering them using data, that you are skilled in interpreting and presenting results, and that you can accomplish these tasks using R. More is not better.

You are encouraged to provide writing that interprets your results and answers your research question. This includes writing a **scope of inference**. The writing is optional for the draft, but will be a requirement on the final.

**Summary** In summary, our research project looked into determining a relationship between factors like age and sex with Covid-19 mortality rates. In terms of age, the data indicated a result similar to the alternative hypothesis in that older individuals will have a higher mortality rate. However, with a $R^2$ value approximately 30%, that leaves majority of the variability unexplained. In context, this would indicate that old age may be a factor in higher morality rates, but there are likely many other factors that are also associated with Covid-19 mortality rates. Since our data was collected in a manner that was neither random assignment nor random sampling, the results found would not be generalizable and not causal.

In terms of sex, the data seems to suggest that males are more prone to death when it comes to Covid-19 cases. However, with a $R^2$ value of 0.001, that means most of the random variables are unexplained. The implications behind this $R^2$ value is that gender has minimal effect on Covid-19 mortality rate.

## Workflow + Formatting

To earn full credit, please be mindful of the following:

Have an updated `about` qmd for your project.

Responded to / Closed all *issues* from your proposal from chosen data set.

Your website must be able to be rendered by me and your lab leader prior to submission.

**EVERYONE** in your group must have at least 3 commits.

Pipes %\>%, \|\> and ggplot layers + should be followed by a new line.

All binary operators should be surrounded by space. For example x + y is appropriate. x+y is not.

All team members should contribute to the GitHub repository, with **regular meaningful commits.**
